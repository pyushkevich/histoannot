{% extends 'base.html' %}

{% block header %}
{% endblock %}

{% block content %}

<style type="text/css">
html {
    overflow: hidden;
}
body {
    margin: 0;
    padding: 0;
}
div#view {
    position: relative;
    left: 0;
    width: 100%;
    height: calc(100vh - 100px);
    background-color: white;
    color: black;
}

button.bottom_button {
    border-radius: 3px;
    margin: 0 5px 5px 5px;
    padding: 2px 0 2px 0;
    cursor: pointer;
}

button.enabled {
    border: 2px solid blue;
    color: blue;
}

button.active, button.enabled:hover {
    background-color: blue;
    color: white;
}

button.disabled, button.disabled:hover {
    color: lightgray;
    border: 2px solid lightgray;
}

</style>
<a href="{{ url_for('slide.index')}}">Home</a> : <a href="{{ url_for('slide.block_detail', id=slide_info['block_id']) }}">{{ slide_info['specimen_name'] }}_{{ slide_info['block_name'] }}</a> : {{ slide_info['section'] }}_{{ slide_info['slide'] }}_{{ slide_info['stain'] }}  

<div id="view"> </div>
<button id="draw_button" class="bottom_button enabled">&nbsp Draw Lines (D) &nbsp</div>
<button id="nav_button" class="bottom_button enabled active">&nbsp Zoom and Pan (Z) &nbsp</div>
<button id="del_button" class="bottom_button disabled">&nbsp Delete (Del) &nbsp</div>

<script type="text/javascript" src="{{ url_for('static', filename='openseadragon-bin-2.4.0/openseadragon.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='jquery.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='openseadragon-scalebar.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='openseadragon-paperjs-overlay.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='mousetrap.min.js') }}"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.9.25/paper-full.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    var viewer = new OpenSeadragon({
        id: "view",
        prefixUrl: "{{ url_for('static', filename='openseadragon-bin-2.4.0/images/') }}",
        showNavigator: true,
        showRotationControl: false,
        showSequenceControl: true,
        animationTime: 0.5,
        blendTime: 0.1,
        constrainDuringPan: true,
        maxZoomPixelRatio: 2,
        minZoomLevel: 1,
        visibilityRatio: 1,
        zoomPerScroll: 2,
        timeout: 120000,
    });
    viewer.addHandler("open", function() {
        // To improve load times, ignore the lowest-resolution Deep Zoom
        // levels.  This is a hack: we can't configure the minLevel via
        // OpenSeadragon configuration options when the viewer is created
        // from DZI XML.
        viewer.source.minLevel = 8;
    });
    var mpp = parseFloat("{{ slide_mpp }}");
    viewer.scalebar({
        pixelsPerMeter: mpp ? (1e6 / mpp) : 0,
        xOffset: 10,
        yOffset: 10,
        barThickness: 3,
        color: '#555555',
        fontColor: '#333333',
        backgroundColor: 'rgba(255, 255, 255, 0.5)',
    });

    // Initialization for paper_js
    var overlay
    function init_paperjs() {
        overlay = viewer.paperjsOverlay();
        overlay.resize();
        overlay.resizecanvas();
    }

    // Paper default settings
    paper.settings.handleSize = 10;

    // Add the tiled image to the viewer and when successful, initialize the overlay
    viewer.addTiledImage({
        tileSource: "{{ url_for('slide.dzi', id=slide_id) }}",
        x: 0,
        y: 0,
        success: init_paperjs
    });

    // Current interaction mode
    var curr_mode = 'NAV'

    // Initialize the paper.js overlay
    var curr_path

    // Helper function to get Point corresponding to OSD event
    var ev_point = function(event) {
        return paper.view.viewToProject(new paper.Point(event.position.x, event.position.y));
    }

    var deselect_all_paths = function() {
        var selected = paper.project.selectedItems;
        for (var i = 0; i < selected.length; i++) {
            var item = selected[i];
            if (item instanceof paper.Path) {
                item.selected = false;
            }
        }
    }

    var press_handler = function(event) {
        if(curr_mode == 'DRAW') {
            curr_path = new paper.Path({
                                       segments: [ev_point(event)],
                                       strokeColor: 'black',
                                       strokeCap: 'round',
                                       strokeWidth: 20 });
        }
        else if(curr_mode == 'NAV') {
            hit = paper.project.hitTest(ev_point(event))
            if(hit) {
                deselect_all_paths();
                hit.item.selected = true;
                fn_update_button_state();
                paper.view.draw();
            }
            
        }
    }

    var drag_handler = function(event) {
        if(curr_mode == 'DRAW') {
            curr_path.add(ev_point(event))
            paper.view.draw();
        }
    }

    var dragEnd_handler = function(event) {
        if(curr_mode == 'DRAW') {
            var start = Date.now();
            curr_path.simplify(10)
            console.log("time elapsed: " + (Date.now() - start) + " ms.")
            paper.view.draw();
            nav_pressed_handler();
        }
    }

    var move_handler = function(event) {
        if(curr_mode == 'NAV' && paper.project) {
            hit = paper.project.hitTest(ev_point(event))
            if(hit) {
                document.getElementById("view").style.cursor = "pointer";
                viewer.setMouseNavEnabled(false);
            }
            else {
                document.getElementById("view").style.cursor = "default";
                viewer.setMouseNavEnabled(true);
            }
        }
    }

    var mouse_tracker = new OpenSeadragon.MouseTracker({
                                                       element: viewer.canvas,
                                                       pressHandler: press_handler,
                                                       dragHandler: drag_handler,
                                                       dragEndHandler: dragEnd_handler,
                                                       moveHandler: move_handler });

    mouse_tracker.setTracking(true);

    // Update button active state
    var fn_update_button_state = function() {
        // Is there an active selection
        if(paper.project.selectedItems.length > 0)
            document.getElementById("del_button").className = 
                document.getElementById("del_button").className.replace(" disabled", " enabled");
        else
            document.getElementById("del_button").className = 
                document.getElementById("del_button").className.replace(" enabled", " disabled");
    }

    
    // Active button decoration
    var fn_active_button = function(element) {
        var current = document.getElementsByClassName("active");
        current[0].className = current[0].className.replace(" active", "");
        element.className += " active";
    }

    // Event handler
    var draw_pressed_handler = function(options) {
        viewer.setMouseNavEnabled(false);
        viewer.outerTracker.setTracking(false);
        curr_mode = 'DRAW';
        fn_active_button(document.getElementById('draw_button'))
    }

    var nav_pressed_handler = function(options) {
        viewer.setMouseNavEnabled(true);
        viewer.outerTracker.setTracking(true);
        curr_mode = 'NAV';
        fn_active_button(document.getElementById('nav_button'))
    }

    var del_pressed_handler = function(options) {
        if(document.getElementById("del_button").className.includes(" enabled")) {
            var selected = paper.project.selectedItems;
            for (var i = 0; i < selected.length; i++) {
                var item = selected[i];
                if (item instanceof paper.Path) {
                    item.remove()
                }
            }
            fn_update_button_state()
            paper.view.draw();
        }
    }

    var drawButton_elt = document.getElementById('draw_button');
    var navButton_elt = document.getElementById('nav_button');
    var delButton_elt = document.getElementById('del_button');

    // Create a drawing button
    var drawButton = new OpenSeadragon.Button({element: drawButton_elt, tooltip: 'Draw line segments on the slide'})
    var navButton = new OpenSeadragon.Button({element: navButton_elt, tooltip: 'Navigate around the slide using zoom and pan'})
    var delButton = new OpenSeadragon.Button({element: delButton_elt, tooltip: 'Delete selected line or text'})

    viewer.addControl(navButton.element, { anchor: OpenSeadragon.ControlAnchor.BOTTOM_LEFT })
    viewer.addControl(drawButton.element, { anchor: OpenSeadragon.ControlAnchor.BOTTOM_LEFT })
    viewer.addControl(delButton.element, { anchor: OpenSeadragon.ControlAnchor.BOTTOM_LEFT })



    drawButton.addHandler('press', draw_pressed_handler)
    navButton.addHandler('press', nav_pressed_handler)
    delButton.addHandler('press', del_pressed_handler)

    window.onresize = function() {
        overlay.resize();
        overlay.resizecanvas(); }

    // Disable viewer keyboard
    viewer.innerTracker.keyDownHandler = null;
    viewer.innerTracker.keyPressHandler = null;
    viewer.innerTracker.keyHandler = null;

    // Some keyboard navigation
    Mousetrap.bind('d', function() { draw_pressed_handler() });
    Mousetrap.bind(['z', 'esc'], function() { nav_pressed_handler() });
    Mousetrap.bind(['backspace', 'del'], function() { del_pressed_handler() });
});
</script>


{% endblock %}
