{% extends 'base.html' %}

{% block header %}
{% endblock %}

{% block content %}

<style type="text/css">
html {
    overflow: hidden;
}
body {
    margin: 0;
    padding: 0;
}
div#view {
    position: relative;
    left: 0;
    width: 100%;
    height: calc(100vh - 120px);
    background-color: white;
    color: black;
}
button.bottom_button {
    border-radius: 3px;
    margin: 0 5px 0 5px;
    padding: 2px 0 2px 0;
    cursor: pointer;
    border: 2px solid blue;
    color: blue;
}

button.active, button.bottom_button:hover {
    background-color: blue;
    color: white;
}

</style>
<a href="{{ url_for('slide.index')}}">Home</a> : <a href="{{ url_for('slide.block_detail', id=slide_info['block_id']) }}">{{ slide_info['specimen_name'] }}_{{ slide_info['block_name'] }}</a> : {{ slide_info['section'] }}_{{ slide_info['slide'] }}_{{ slide_info['stain'] }}  

<div id="view"> </div>
<button id="draw_button" class="bottom_button">&nbsp Draw Lines &nbsp</div>
<button id="nav_button" class="bottom_button active">&nbsp Zoom and Pan &nbsp</div>

<script type="text/javascript" src="{{ url_for('static', filename='openseadragon-bin-2.4.0/openseadragon.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='jquery.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='openseadragon-scalebar.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='openseadragon-fabricjs-overlay.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='fabric/fabric.adapted.js') }}"></script>
<script type="text/javascript">
$(document).ready(function() {
    var viewer = new OpenSeadragon({
        id: "view",
        tileSources: "{{ url_for('slide.dzi', id=slide_id) }}",
        prefixUrl: "{{ url_for('static', filename='openseadragon-bin-2.4.0/images/') }}",
        showNavigator: true,
        showRotationControl: false,
        showSequenceControl: true,
        animationTime: 0.5,
        blendTime: 0.1,
        constrainDuringPan: true,
        maxZoomPixelRatio: 2,
        minZoomLevel: 1,
        visibilityRatio: 1,
        zoomPerScroll: 2,
        timeout: 120000,
    });
    viewer.addHandler("open", function() {
        // To improve load times, ignore the lowest-resolution Deep Zoom
        // levels.  This is a hack: we can't configure the minLevel via
        // OpenSeadragon configuration options when the viewer is created
        // from DZI XML.
        viewer.source.minLevel = 8;
    });
    var mpp = parseFloat("{{ slide_mpp }}");
    viewer.scalebar({
        pixelsPerMeter: mpp ? (1e6 / mpp) : 0,
        xOffset: 10,
        yOffset: 10,
        barThickness: 3,
        color: '#555555',
        fontColor: '#333333',
        backgroundColor: 'rgba(255, 255, 255, 0.5)',
    });

    // initialize overlay
    var options = { scale: 1000 }
    var overlay = viewer.fabricjsOverlay(options);

    // Active button decoration
    var fn_active_button = function(element) {
        var current = document.getElementsByClassName("active");
        current[0].className = current[0].className.replace(" active", "");
        element.className += " active";
    }

    // Event handler
    var draw_pressed_handler = function(options) {
        viewer.setMouseNavEnabled(false);
        viewer.outerTracker.setTracking(false);
        overlay.fabricCanvas().isDrawingMode=true;
        fn_active_button(document.getElementById('draw_button'))
    }

    var nav_pressed_handler = function(options) {
        viewer.setMouseNavEnabled(true);
        viewer.outerTracker.setTracking(true);
        overlay.fabricCanvas().isDrawingMode=false;
        fn_active_button(document.getElementById('nav_button'))
    }

    var drawButton_elt = document.getElementById('draw_button');
    var navButton_elt = document.getElementById('nav_button');

    // Create a drawing button
    var drawButton = new OpenSeadragon.Button({element: drawButton_elt, tooltip: 'Draw line segments on the slide'})
    var navButton = new OpenSeadragon.Button({element: navButton_elt, tooltip: 'Navigate around the slide using zoom and pan'})

    viewer.addControl(navButton.element, { anchor: OpenSeadragon.ControlAnchor.BOTTOM_LEFT })
    viewer.addControl(drawButton.element, { anchor: OpenSeadragon.ControlAnchor.BOTTOM_LEFT })

    drawButton.addHandler('press', draw_pressed_handler)
    navButton.addHandler('press', nav_pressed_handler)


    // Paint something on the overlay
    var my_rect = new fabric.Rect({left:200, top:200, width:40, height:40, fill:'orange'})
    overlay.fabricCanvas().add(my_rect)


    
});
</script>


{% endblock %}
